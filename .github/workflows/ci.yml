name: Cross-Platform CI

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

env:
  BUILD_TYPE: Release

jobs:
  # Linux build with multiple compilers
  linux-build:
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-22.04]
        compiler: 
          - { cc: gcc-11, cxx: g++-11 }
          - { cc: clang-14, cxx: clang++-14 }
    
    runs-on: ${{ matrix.os }}
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          libglfw3-dev \
          libvulkan-dev \
          vulkan-tools \
          vulkan-validationlayers-dev \
          glslang-tools \
          python3 \
          ${{ matrix.compiler.cc }} \
          ${{ matrix.compiler.cxx }}
    
    - name: Verify Vulkan installation
      run: |
        vulkaninfo --summary || echo "No Vulkan runtime available (expected in CI)"
    
    - name: Configure CMake
      env:
        CC: ${{ matrix.compiler.cc }}
        CXX: ${{ matrix.compiler.cxx }}
      run: |
        cmake -B build \
          -DCMAKE_BUILD_TYPE=${{ env.BUILD_TYPE }} \
          -Wno-dev \
          --log-level=NOTICE
    
    - name: Build
      run: cmake --build build --parallel $(nproc)
    
    - name: Check architecture boundaries
      run: python3 tools/check_folder_dependencies.py
    
    - name: Verify shader compilation
      run: |
        ls -la shaders/*.spv
        echo "Shader count: $(ls shaders/*.spv | wc -l)"
    
    - name: Upload build artifacts
      uses: actions/upload-artifact@v3
      with:
        name: linux-build-${{ matrix.compiler.cc }}
        path: |
          bin/CapitalEngine
          shaders/*.spv
        retention-days: 7

  # Windows build
  windows-build:
    runs-on: windows-2022
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Install Vulkan SDK
      run: |
        # Download and install Vulkan SDK
        # Note: This is a simplified example, actual implementation may vary
        Invoke-WebRequest -Uri "https://sdk.lunarg.com/sdk/download/latest/windows/vulkan-sdk.exe" -OutFile vulkan-sdk.exe
        Start-Process -Wait -FilePath .\vulkan-sdk.exe -ArgumentList "/S"
      continue-on-error: true  # SDK may not be available in CI
    
    - name: Install GLFW (via vcpkg)
      run: |
        git clone https://github.com/Microsoft/vcpkg.git
        .\vcpkg\bootstrap-vcpkg.bat
        .\vcpkg\vcpkg install glfw3:x64-windows
      continue-on-error: true
    
    - name: Configure CMake
      run: |
        cmake -B build `
          -DCMAKE_BUILD_TYPE=${{ env.BUILD_TYPE }} `
          -DCMAKE_TOOLCHAIN_FILE=vcpkg/scripts/buildsystems/vcpkg.cmake `
          -Wno-dev
      continue-on-error: true  # May fail without Vulkan SDK
    
    - name: Build
      run: cmake --build build --config ${{ env.BUILD_TYPE }} --parallel
      continue-on-error: true
    
    - name: Check architecture boundaries
      run: python3 tools/check_folder_dependencies.py
    
    - name: Upload build artifacts
      uses: actions/upload-artifact@v3
      if: success()
      with:
        name: windows-build
        path: |
          bin/*.exe
          shaders/*.spv
        retention-days: 7

  # macOS build with MoltenVK
  macos-build:
    runs-on: macos-13
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Install dependencies
      run: |
        brew install glfw vulkan-headers molten-vk glslang python3
    
    - name: Configure CMake
      run: |
        cmake -B build \
          -DCMAKE_BUILD_TYPE=${{ env.BUILD_TYPE }} \
          -Wno-dev \
          --log-level=NOTICE
    
    - name: Build
      run: cmake --build build --parallel $(sysctl -n hw.ncpu)
    
    - name: Check architecture boundaries
      run: python3 tools/check_folder_dependencies.py
    
    - name: Upload build artifacts
      uses: actions/upload-artifact@v3
      with:
        name: macos-build
        path: |
          bin/CapitalEngine
          shaders/*.spv
        retention-days: 7

  # Code quality checks
  code-quality:
    runs-on: ubuntu-22.04
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Install clang-format
      run: sudo apt-get install -y clang-format-14
    
    - name: Check code formatting
      run: |
        find src -type f \( -name "*.cpp" -o -name "*.h" \) -print0 | \
          xargs -0 clang-format-14 --dry-run --Werror
      continue-on-error: true  # Don't fail build on formatting issues
    
    - name: Check architecture boundaries
      run: python3 tools/check_folder_dependencies.py

  # Shader validation
  shader-validation:
    runs-on: ubuntu-22.04
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Install shader tools
      run: sudo apt-get install -y glslang-tools spirv-tools
    
    - name: Compile and validate shaders
      run: |
        mkdir -p shaders_validated
        for shader in shaders/*.vert shaders/*.frag shaders/*.comp; do
          if [ -f "$shader" ]; then
            filename=$(basename "$shader")
            name="${filename%.*}"
            ext="${filename##*.}"
            
            echo "Compiling $shader..."
            glslangValidator -V "$shader" -o "shaders_validated/${name}.${ext}.spv"
            
            echo "Validating ${name}.${ext}.spv..."
            spirv-val "shaders_validated/${name}.${ext}.spv"
          fi
        done
    
    - name: Upload validated shaders
      uses: actions/upload-artifact@v3
      with:
        name: validated-shaders
        path: shaders_validated/*.spv
        retention-days: 7

  # Dependency audit (security check)
  dependency-audit:
    runs-on: ubuntu-22.04
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Check for vendored library versions
      run: |
        echo "Checking vendored library versions..."
        python3 << 'EOF'
        import re
        import os
        
        libs = {
            'libraries/vk_mem_alloc.h': r'(?:version|VERSION)\s+(\d+\.\d+\.\d+)',
            'libraries/stb_image.h': r'stb_image\s+-\s+v(\d+\.\d+)',
            'libraries/stb_image_write.h': r'stb_image_write\s+-\s+v(\d+\.\d+)',
            'libraries/tiny_obj_loader.h': r'(?:version|VERSION)\s+(\d+\.\d+\.\d+)',
        }
        
        for lib, pattern in libs.items():
            if os.path.exists(lib):
                with open(lib, 'r', encoding='utf-8', errors='ignore') as f:
                    content = f.read(10000)  # Read first 10KB
                    match = re.search(pattern, content, re.IGNORECASE)
                    if match:
                        print(f"{lib}: Version {match.group(1)}")
                    else:
                        print(f"{lib}: Version not found (needs documentation)")
        EOF
    
    - name: Remind about version documentation
      run: |
        echo "⚠️  Remember to keep libraries/VERSIONS.md up to date!"
        echo "    Run quarterly security audits on dependencies."

  # Summary job
  ci-summary:
    needs: [linux-build, code-quality, shader-validation, dependency-audit]
    runs-on: ubuntu-22.04
    if: always()
    
    steps:
    - name: Check build status
      run: |
        echo "CI Build Summary:"
        echo "  Linux Build: ${{ needs.linux-build.result }}"
        echo "  Code Quality: ${{ needs.code-quality.result }}"
        echo "  Shader Validation: ${{ needs.shader-validation.result }}"
        echo "  Dependency Audit: ${{ needs.dependency-audit.result }}"
