name: Trigger Agent Run (via Multibox)

on:
  workflow_dispatch:
    inputs:
      mode:
        description: "Run mode: main task or self-selected maintenance task"
        required: true
        type: choice
        default: main
        options:
          - main
          - self
      macro:
        description: "Macro to run (leave empty for full sequence)"
        required: false
        type: choice
        default: ""
        options:
          - ""
          - Charge
          - Pull
          - Follow
          - Think
          - Guild
          - Warrior
          - Rogue
          - Mage
          - Hunter
          - Shaman
          - Priest
          - Party
      task_command:
        description: "Task override (e.g. 'triple buffering'). Blank = use current-task.md"
        required: false
        type: string
        default: ""
      auto_apply_patch:
        description: "Guarded auto-apply patch before PR"
        required: true
        type: boolean
        default: true
      target_ref:
        description: "Branch to check out on target repo"
        required: false
        type: string
        default: "dev-linux"
      target_manifest:
        description: "Target repo manifest name (file in .github/agents/targets/)"
        required: false
        type: string
        default: "generations"
      chain:
        description: "Auto-chain: trigger follow-up run from agent Next Run recommendations"
        required: false
        type: boolean
        default: false
      chain_depth:
        description: "Current chain depth (0 = first run). Auto-incremented by chaining."
        required: false
        type: string
        default: "0"

jobs:
  dispatch:
    runs-on: ubuntu-latest
    steps:
      - name: Trigger agent run on Multibox
        uses: peter-evans/repository-dispatch@v3
        with:
          token: ${{ secrets.MULTIBOX_PAT }}
          repository: CorrelateVisuals/Multibox
          event-type: agent-run
          client-payload: |
            {
              "mode": "${{ github.event.inputs.mode }}",
              "macro": "${{ github.event.inputs.macro }}",
              "task_command": "${{ github.event.inputs.task_command }}",
              "auto_apply_patch": "${{ github.event.inputs.auto_apply_patch }}",
              "target_ref": "${{ github.event.inputs.target_ref }}",
              "target_manifest": "${{ github.event.inputs.target_manifest }}",
              "chain": "${{ github.event.inputs.chain }}",
              "chain_depth": "${{ github.event.inputs.chain_depth }}"
            }
