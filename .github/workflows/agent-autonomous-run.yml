name: Agent Autonomous Run

on:
  workflow_dispatch:
    inputs:
      mode:
        description: "Run mode: main task or self-selected maintenance task"
        required: true
        type: choice
        default: main
        options:
          - main
          - self
      macro:
        description: "Macro to run (leave empty for full sequence)"
        required: false
        type: choice
        default: ""
        options:
          - ""
          - Charge
          - Position
          - Follow
          - Think
          - Party
          - lead++
          - agents++
      task_command:
        description: "Task override (e.g. 'triple buffering'). Blank = use current-task.md"
        required: false
        type: string
        default: ""
      auto_apply_patch:
        description: "Guarded auto-apply patch before PR"
        required: true
        type: boolean
        default: true

permissions:
  contents: write
  pull-requests: write
  issues: write

jobs:
  run-agents:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ github.ref }}
          fetch-depth: 0

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Decide mode and apply behavior
        id: decide
        shell: bash
        run: |
          MODE="main"
          AUTO_APPLY="true"
          MACRO=""

          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            MODE="${{ github.event.inputs.mode }}"
            AUTO_APPLY="${{ github.event.inputs.auto_apply_patch }}"
            MACRO="${{ github.event.inputs.macro }}"
          elif [ "${{ github.event_name }}" = "schedule" ]; then
            case "${{ github.event.schedule }}" in
              "0 11 * * 2,4") MODE="self" ;;
              *) MODE="main" ;;
            esac
          fi

          echo "mode=$MODE" >> "$GITHUB_OUTPUT"
          echo "auto_apply=$AUTO_APPLY" >> "$GITHUB_OUTPUT"
          echo "macro=$MACRO" >> "$GITHUB_OUTPUT"

      - name: Run sequential agent orchestration
        env:
          LLM_PROVIDER: ${{ vars.LLM_PROVIDER || 'openai' }}
          LLM_API_KEY: ${{ secrets.LLM_API_KEY }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          MACRO_MODE: ${{ steps.decide.outputs.macro }}
          LLM_MODEL: ${{ vars.LLM_MODEL || 'gpt-4o-mini' }}
          LLM_API_URL: ${{ vars.LLM_API_URL }}
          TASK_MODE: ${{ steps.decide.outputs.mode }}
          AUTO_APPLY_PATCH: ${{ steps.decide.outputs.auto_apply }}
          MAX_PATCH_FILES: ${{ vars.MAX_PATCH_FILES || '8' }}
          MAX_PATCH_LINES: ${{ vars.MAX_PATCH_LINES || '400' }}
          GUARD_BUILD_CMD: ${{ vars.GUARD_BUILD_CMD || '' }}
          TASK_COMMAND: ${{ github.event.inputs.task_command }}
        run: |
          python .github/scripts/agent_autorun.py

      - name: Create reminder issue
        uses: actions/github-script@v7
        with:
          script: |
            const today = new Date().toISOString().slice(0, 10)
            const mode = `${{ steps.decide.outputs.mode }}`
            const autoApply = `${{ steps.decide.outputs.auto_apply }}`
            const title = `Agent Autonomous Run ${today} (${mode})`
            const body = [
              `Automated sequential run completed for ${today}.`,
              `Mode: ${mode}`,
              `Guarded auto-apply patch: ${autoApply}`,
              '',
              'Generated artifacts:',
              '- `.github/agents/runs/`',
              '- `.github/agents/proposals/`',
              '',
              'Guardrails enforce allowed file scope and patch-size limits.',
              'Review generated PR carefully before merge.'
            ].join('\n')

            const { data: issues } = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'agent-run'
            })

            const alreadyExists = issues.some(i => i.title === title)
            if (!alreadyExists) {
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title,
                body,
                labels: ['agent-run']
              })
            }

      - name: Create PR with run artifacts
        uses: peter-evans/create-pull-request@v6
        with:
          commit-message: "chore(agents): autonomous run outputs"
          title: "chore(agents): autonomous run outputs (${{ steps.decide.outputs.mode }})"
          body: |
            Automated sequential agent run output.

            Includes:
            - Run report under `.github/agents/runs/`
            - Proposal markdown + patch under `.github/agents/proposals/`

            Auto-apply mode is guarded by scope/size/build checks.
            Always review changes before merge.
          branch: "automation/agent-run-${{ github.run_id }}"
          labels: |
            agent-run
            automation
