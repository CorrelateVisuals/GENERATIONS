# CHARGE-SWAPCHAIN-RECREATION — 2026-02-18

**Macro**: charge | **Agents**: C++ Lead → Vulkan Guru | **Status**: completed

## Agent Summary

| Agent | Finding |
|-------|---------|
| C++ Lead | - [ ] `src/vulkan_mechanics/Mechanics.cpp` — Add error handling for `swapchain.recreate()` to ensure proper cleanup and reinitialization of Vulkan resources. [RISK: high] |
| Vulkan Guru | - [ ] `src/vulkan_mechanics/Mechanics.cpp` — Add Vulkan-specific validation for `swapchain.recreate()` to ensure proper handling of image layouts, synchronization barriers, and resource transitions. [ |

## TODOs

- [ ] `src/vulkan_mechanics/Mechanics.cpp` — Add error handling for `swapchain.recreate()` to ensure proper cleanup and reinitialization of Vulkan resources. [RISK: high]
- [ ] `src/vulkan_mechanics/Mechanics.cpp` — Validate that the `swapchain.recreate()` method properly handles surface changes, queue families, and synchronization objects. [RISK: high]
- [ ] `src/vulkan_mechanics/Mechanics.cpp` — Ensure that the swapchain recreation logic accounts for device loss or surface invalidation scenarios. [RISK: high]
- [ ] `shaders/ParameterUBO.glsl` — Verify that any changes to the swapchain do not affect shader uniform buffer object (UBO) compatibility. [RISK: medium]
- [ ] `shaders/Engine.comp` — Confirm that the swapchain recreation does not introduce frame synchronization issues in compute shaders. [RISK: medium]
- [ ] `src/engine/CapitalEngine.cpp` — Refactor `recreate_swapchain()` to improve readability and modularity by breaking down the method into smaller, more focused helper functions. [RISK: low]
- [ ] `src/engine/CapitalEngine.h` — Ensure that the `recreate_swapchain()` method is properly documented, including its preconditions, postconditions, and potential failure modes. [RISK: low]
- [ ] `src/vulkan_mechanics/Mechanics.cpp` — Add Vulkan-specific validation for `swapchain.recreate()` to ensure proper handling of image layouts, synchronization barriers, and resource transitions. [RISK: high]
- [ ] `src/vulkan_mechanics/Mechanics.cpp` — Ensure that the `swapchain.recreate()` method properly destroys old swapchain resources (images, framebuffers, semaphores) before creating new ones to avoid memory leaks. [RISK: high]
- [ ] `src/vulkan_mechanics/Mechanics.cpp` — Validate that the swapchain recreation logic correctly handles Vulkan extensions (e.g., `VK_KHR_swapchain`) and ensures compatibility with the current physical device and surface. [RISK: high]
- [ ] `src/vulkan_base/VulkanBaseSync.cpp` — Verify that synchronization objects (fences, semaphores) are reset or recreated as needed during swapchain recreation. [RISK: medium]
- [ ] `src/vulkan_base/VulkanBaseResources.cpp` — Ensure that any Vulkan resources (e.g., images, buffers) tied to the old swapchain are properly transitioned or destroyed. [RISK: medium]
- [ ] `shaders/ParameterUBO.glsl` — Confirm that the swapchain recreation does not introduce mismatches in UBO layouts or binding indices. [RISK: medium]
- [ ] `shaders/Engine.comp` — Validate that compute shader dispatches remain synchronized with the new swapchain images and framebuffers. [RISK: medium]
- [ ] `src/engine/CapitalEngine.cpp` — Refactor `recreate_swapchain()` to separate Vulkan-specific logic (e.g., resource cleanup, synchronization) into helper functions for better modularity. [RISK: low]
- [ ] `src/engine/CapitalEngine.h` — Add detailed documentation for `recreate_swapchain()` to describe its lifecycle, dependencies, and failure handling. [RISK: low]

## C++ Lead
## TODOs

### Vulkan Guru TODOs
- [ ] `src/vulkan_mechanics/Mechanics.cpp` — Add error handling for `swapchain.recreate()` to ensure proper cleanup and reinitialization of Vulkan resources. [RISK: high]
- [ ] `src/vulkan_mechanics/Mechanics.cpp` — Validate that the `swapchain.recreate()` method properly handles surface changes, queue families, and synchronization objects. [RISK: high]
- [ ] `src/vulkan_mechanics/Mechanics.cpp` — Ensure that the swapchain recreation logic accounts for device loss or surface invalidation scenarios. [RISK: high]

### Kernel Expert TODOs
- [ ] `shaders/ParameterUBO.glsl` — Verify that any changes to the swapchain do not affect shader uniform buffer object (UBO) compatibility. [RISK: medium]
- [ ] `shaders/Engine.comp` — Confirm that the swapchain recreation does not introduce frame synchronization issues in compute shaders. [RISK: medium]

### Refactorer TODOs
- [ ] `src/engine/CapitalEngine.cpp` — Refactor `recreate_swapchain()` to improve readability and modularity by breaking down the method into smaller, more focused helper functions. [RISK: low]
- [ ] `src/engine/CapitalEngine.h` — Ensure that the `recreate_swapchain()` method is properly documented, including its preconditions, postconditions, and potential failure modes. [RISK: low]

## Code Proposal

```cpp
// src/engine/CapitalEngine.cpp

void CapitalEngine::recreate_swapchain() {
  try {
    Log::text(Log::Style::header_guard);
    Log::text("| Recreating Swapchain");

    // Log the current state before recreation
    Log::text("Current Swapchain State:");
    Log::text("  - Last Presented Image Index: " + std::to_string(last_presented_image_index));
    Log::text("  - Last Submitted Frame Index: " + std::to_string(last_submitted_frame_index));

    // Perform swapchain recreation
    mechanics.swapchain.recreate(mechanics.init_vulkan.surface,
                                 mechanics.queues,
                                 mechanics.sync_objects,
                                 *pipelines,
                                 *resources);

    // Log success
    Log::text("| Swapchain successfully recreated");
    Log::text(Log::Style::header_guard);
  } catch (const std::exception &e) {
    // Log the error and rethrow
    Log::text(Log::Style::header_guard);
    Log::text("| ERROR: Swapchain recreation failed: " + std::string(e.what()));
    Log::text(Log::Style::header_guard);
    throw;
  }
}
```

## Next Run

- **Next Agent**: Vulkan Guru
- **Task Command**: Va

... [output truncated by factory gate] ...

## Vulkan Guru
## TODOs

### Vulkan Guru TODOs
- [ ] `src/vulkan_mechanics/Mechanics.cpp` — Add Vulkan-specific validation for `swapchain.recreate()` to ensure proper handling of image layouts, synchronization barriers, and resource transitions. [RISK: high]
- [ ] `src/vulkan_mechanics/Mechanics.cpp` — Ensure that the `swapchain.recreate()` method properly destroys old swapchain resources (images, framebuffers, semaphores) before creating new ones to avoid memory leaks. [RISK: high]
- [ ] `src/vulkan_mechanics/Mechanics.cpp` — Validate that the swapchain recreation logic correctly handles Vulkan extensions (e.g., `VK_KHR_swapchain`) and ensures compatibility with the current physical device and surface. [RISK: high]
- [ ] `src/vulkan_base/VulkanBaseSync.cpp` — Verify that synchronization objects (fences, semaphores) are reset or recreated as needed during swapchain recreation. [RISK: medium]
- [ ] `src/vulkan_base/VulkanBaseResources.cpp` — Ensure that any Vulkan resources (e.g., images, buffers) tied to the old swapchain are properly transitioned or destroyed. [RISK: medium]

### Kernel Expert TODOs
- [ ] `shaders/ParameterUBO.glsl` — Confirm that the swapchain recreation does not introduce mismatches in UBO layouts or binding indices. [RISK: medium]
- [ ] `shaders/Engine.comp` — Validate that compute shader dispatches remain synchronized with the new swapchain images and framebuffers. [RISK: medium]

### Refactorer TODOs
- [ ] `src/engine/CapitalEngine.cpp` — Refactor `recreate_swapchain()` to separate Vulkan-specific logic (e.g., resource cleanup, synchronization) into helper functions for better modularity. [RISK: low]
- [ ] `src/engine/CapitalEngine.h` — Add detailed documentation for `recreate_swapchain()` to describe its lifecycle, dependencies, and failure handling. [RISK: low]

## Code Proposal

```cpp
// src/vulkan_mechanics/Mechanics.cpp

void Mechanics::recreate_swapchain(VkSurfaceKHR surface,
                                   const Queues &queues,
                                   SyncObjects &sync_objects,
                                   Pipelines &pipelines,
                                   VulkanResources &resources) {
  // Destroy old swapchain resources
  vkDeviceWaitIdle(device); // Ensure no resources are in use
  cleanup_swapchain_resources();

  // Recreate swapchain
  swapchain.create(surface, queues, sync_objects);

  // Recreate dependent resources
  resources.recreate_for_swapchain(swapchain);
  pipelines.recreate_for_swapchain(swapchain)

... [output truncated by factory gate] ...

## Next Run

- **C++ Lead**: - **Next Agent**: Vulkan Guru
- **Task Command**: Validate and enhance Vulkan resource handling during swapchain recreation.
- **Vulkan Guru**: - **Next Agent**: Kernel Expert
- **Task Command**: Validate shader compatibility and synchronization with the new swapchain.

## Factory Metrics (trailing 7 days)

| Metric | Value |
|--------|-------|
| Total agent calls | 2 |
| Pass rate | 2/2 (100%) |
| Retry rate | 0/2 |
| Halt rate | 0/2 |
| Warn rate | 0/2 |
| Cache hit rate | 0/2 (0%) |
| Avg latency | 6238ms |

### Agent Reliability

| Agent | Pass Rate |
|-------|----------|
| C++ Lead | 1/1 (100%) |
| Vulkan Guru | 1/1 (100%) |
